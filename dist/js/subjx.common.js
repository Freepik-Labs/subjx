/*@license
* Drag/Rotate/Resize Library
* Released under the MIT license, 2018-2020
* Karen Sarksyan
* nichollascarter@gmail.com
*/
"use strict";const requestAnimFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return setTimeout(t,1e3/60)},cancelAnimFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||function(t){clearTimeout(t)},{forEach:forEach,slice:arrSlice,map:arrMap,reduce:arrReduce}=Array.prototype,{warn:warn}=console,isDef=t=>null!=t,isUndef=t=>null==t,isFunc=t=>"function"==typeof t,createMethod=t=>isFunc(t)?function(){t.call(this,...arguments)}:()=>{},rotateCoordinates=function(t,e,s,o,r){let a=Math.cos,n=Math.sin;return{x:(t-s)*a(r=r*Math.PI/180)-(e-o)*n(r)+s,y:(t-s)*n(r)+(e-o)*a(r)+o}};class Helper{constructor(t){if("string"==typeof t){const e=document.querySelectorAll(t);this.length=e.length;for(let t=0;t<this.length;t++)this[t]=e[t]}else if("object"!=typeof t||1!==t.nodeType&&t!==document)if(t instanceof Helper){this.length=t.length;for(let e=0;e<this.length;e++)this[e]=t[e]}else{if(!isIterable(t))throw new Error("Passed parameter must be selector/element/elementArray");this.length=0;for(let e=0;e<this.length;e++)1===t.nodeType&&(this[e]=t[e],this.length++)}else this[0]=t,this.length=1}css(t){const e={setStyle(t){return((t,e)=>{let s=t.length;for(;s--;)for(const o in e)t[s].style[o]=e[o];return t.style})(this,t)},getStyle(){return(e=>{let s=e.length;for(;s--;)return e[s].currentStyle?e[s].currentStyle[t]:document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(e[s],"")[t]:e[s].style[t]})(this)}};return"string"==typeof t?e.getStyle.apply(this,arrSlice.call(arguments,1)):"object"!=typeof t&&t?(warn(`Method ${t} does not exist`),!1):e.setStyle.apply(this,arguments)}on(){let t=this.length;for(;t--;)this[t].events||(this[t].events={},this[t].events[arguments[0]]=[]),"string"!=typeof arguments[1]?document.addEventListener?this[t].addEventListener(arguments[0],arguments[1],arguments[2]||{passive:!1}):document.attachEvent?this[t].attachEvent(`on${arguments[0]}`,arguments[1]):this[t][`on${arguments[0]}`]=arguments[1]:listenerDelegate(this[t],arguments[0],arguments[1],arguments[2],arguments[3],!0);return this}off(){let t=this.length;for(;t--;)this[t].events||(this[t].events={},this[t].events[arguments[0]]=[]),"string"!=typeof arguments[1]?document.removeEventListener?this[t].removeEventListener(arguments[0],arguments[1],arguments[2]):document.detachEvent?this[t].detachEvent(`on${arguments[0]}`,arguments[1]):this[t][`on${arguments[0]}`]=null:listenerDelegate(this[t],arguments[0],arguments[1],arguments[2],arguments[3],!1);return this}is(t){if(isUndef(t))return!1;const e=helper(t);let s=this.length;for(;s--;)if(this[s]===e[s])return!0;return!1}}function listenerDelegate(t,e,s,o,r,a){const n=function(t){let e=t.target;for(;e&&e!==this;)e.matches(s)&&o.call(e,t),e=e.parentNode};!0===a?document.addEventListener?t.addEventListener(e,n,r||{passive:!1}):document.attachEvent?t.attachEvent(`on${e}`,n):t[`on${e}`]=n:document.removeEventListener?t.removeEventListener(e,n,r||{passive:!1}):document.detachEvent?t.detachEvent(`on${e}`,n):t[`on${e}`]=null}function isIterable(t){return isDef(t)&&"object"==typeof t&&(Array.isArray(t)||isDef(window.Symbol)&&"function"==typeof t[window.Symbol.iterator]||isDef(t.forEach)||"number"==typeof t.length&&(0===t.length||t.length>0&&t.length-1 in t))}function helper(t){return new Helper(t)}class Observable{constructor(){this.observers={}}subscribe(t,e){const s=this.observers;return isUndef(s[t])&&Object.defineProperty(s,t,{value:[]}),s[t].push(e),this}unsubscribe(t,e){const s=this.observers;if(isDef(s[t])){const o=s[t].indexOf(e);s[t].splice(o,1)}return this}notify(t,e,s){isUndef(this.observers[t])||this.observers[t].forEach(o=>{if(e!==o)switch(t){case"onmove":o.notifyMove(s);break;case"onrotate":o.notifyRotate(s);break;case"onresize":o.notifyResize(s);break;case"onapply":o.notifyApply(s);break;case"ongetstate":o.notifyGetState(s)}})}}class Event{constructor(t){this.name=t,this.callbacks=[]}registerCallback(t){this.callbacks.push(t)}removeCallback(t){const e=this.callbacks(t);this.callbacks.splice(e,1)}}class EventDispatcher{constructor(){this.events={}}registerEvent(t){this.events[t]=new Event(t)}emit(t,e,s){this.events[e].callbacks.forEach(e=>{e.call(t,s)})}addEventListener(t,e){this.events[t].registerCallback(e)}removeEventListener(t,e){this.events[t].removeCallback(e)}}class SubjectModel{constructor(t){this.el=t,this.storage=null,this.proxyMethods=null,this.eventDispatcher=new EventDispatcher,this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onTouchMove=this._onTouchMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._animate=this._animate.bind(this)}enable(t){this._processOptions(t),this._init(this.el),this.proxyMethods.onInit.call(this,this.el)}disable(){throwNotImplementedError()}_init(){throwNotImplementedError()}_destroy(){throwNotImplementedError()}_processOptions(){throwNotImplementedError()}_start(){throwNotImplementedError()}_moving(){throwNotImplementedError()}_end(){throwNotImplementedError()}_animate(){throwNotImplementedError()}_drag({dx:t,dy:e,...s}){const{transform:o,fixedDeltas:r}=this._processMove(t,e),a={dx:t,dy:e,transform:o,...s,...r};this.proxyMethods.onMove.call(this,a),this._emitEvent("drag",a)}_draw(){this._animate()}_onMouseDown(t){this._start(t),helper(document).on("mousemove",this._onMouseMove).on("mouseup",this._onMouseUp)}_onTouchStart(t){this._start(t.touches[0]),helper(document).on("touchmove",this._onTouchMove).on("touchend",this._onTouchEnd)}_onMouseMove(t){t.preventDefault&&t.preventDefault(),this._moving(t,this.el)}_onTouchMove(t){t.preventDefault&&t.preventDefault(),this._moving(t.touches[0],this.el)}_onMouseUp(t){helper(document).off("mousemove",this._onMouseMove).off("mouseup",this._onMouseUp),this._end(t,this.el)}_onTouchEnd(t){helper(document).off("touchmove",this._onTouchMove).off("touchend",this._onTouchEnd),0===t.touches.length&&this._end(t.changedTouches[0],this.el)}_emitEvent(){this.eventDispatcher.emit(this,...arguments)}on(t,e){return this.eventDispatcher.addEventListener(t,e),this}off(t,e){return this.eventDispatcher.removeEventListener(t,e),this}}const throwNotImplementedError=()=>{throw Error("Method not implemented")},EVENTS=["dragStart","drag","dragEnd","resizeStart","resize","resizeEnd","rotateStart","rotate","rotateEnd","setPointStart","setPointEnd"],RAD=Math.PI/180,snapToGrid=(t,e)=>{if(0===e)return t;{const s=snapCandidate(t,e);if(s-t<e)return s}},snapCandidate=(t,e)=>0===e?t:Math.round(t/e)*e,floatToFixed=(t,e=6)=>Number(t.toFixed(e)),getOffset=t=>t.getBoundingClientRect(),getTransform=t=>{return t.css("-webkit-transform")||t.css("-moz-transform")||t.css("-ms-transform")||t.css("-o-transform")||t.css("transform")||"none"},parseMatrix=t=>{const e=t.match(/[+\-]?(?:0|[1-9]\d*)(?:\.\d*)?(?:[eE][+\-]?\d+)?/g);return e?e.map(t=>parseFloat(t)):[1,0,0,1,0,0]},addClass=(t,e)=>{if(e){if(t.classList){if(!(e.indexOf(" ")>-1))return t.classList.add(e);e.split(/\s+/).forEach(e=>t.classList.add(e))}return t}},removeClass=(t,e)=>{if(e){if(t.classList){if(!(e.indexOf(" ")>-1))return t.classList.remove(e);e.split(/\s+/).forEach(e=>t.classList.remove(e))}return t}},objectsCollide=(t,e)=>{const{top:s,left:o}=getOffset(t),{top:r,left:a}=getOffset(e),n=helper(t),i=helper(e);return!(s<r||s+parseFloat(n.css("height"))>r+parseFloat(i.css("height"))||o<a||o+parseFloat(n.css("width"))>a+parseFloat(i.css("width")))},matrixToCSS=t=>{const e=`matrix(${t.join()})`;return{transform:e,webkitTranform:e,mozTransform:e,msTransform:e,otransform:e}},svgPoint=createSVGElement("svg").createSVGPoint(),floatRE=/[+-]?\d+(\.\d+)?/g,ALLOWED_ELEMENTS=["circle","ellipse","image","line","path","polygon","polyline","rect","text","g","foreignobject"];function createSVGElement(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}const checkChildElements=t=>{const e=[];return isGroup(t)?forEach.call(t.childNodes,t=>{if(1===t.nodeType){const s=t.tagName.toLowerCase();-1!==ALLOWED_ELEMENTS.indexOf(s)&&("g"===s&&e.push(...checkChildElements(t)),e.push(t))}}):e.push(t),e},createSVGMatrix=()=>createSVGElement("svg").createSVGMatrix(),getTransformToElement=(t,e)=>{return(e.getScreenCTM()||createSVGMatrix()).inverse().multiply(t.getScreenCTM()||createSVGMatrix())},matrixToString=t=>{const{a:e,b:s,c:o,d:r,e:a,f:n}=t;return`matrix(${e},${s},${o},${r},${a},${n})`},pointTo=(t,e,s)=>(svgPoint.x=e,svgPoint.y=s,svgPoint.matrixTransform(t)),cloneMatrix=t=>{const e=createSVGMatrix();return e.a=t.a,e.b=t.b,e.c=t.c,e.d=t.d,e.e=t.e,e.f=t.f,e},checkElement=t=>{const e=t.tagName.toLowerCase();return-1!==ALLOWED_ELEMENTS.indexOf(e)||(warn("Selected element "+e+" is not allowed to transform. Allowed elements:\ncircle, ellipse, image, line, path, polygon, polyline, rect, text, g, foreignObject"),!1)},createPoint=(t,e,s)=>{if(isUndef(e)||isUndef(s))return null;const o=t.createSVGPoint();return o.x=e,o.y=s,o},isGroup=t=>"g"===t.tagName.toLowerCase(),shouldKeepTransformations=t=>["g","svg","rect","foreignobject"].includes(t.tagName.toLowerCase()),parsePoints=t=>t.match(floatRE).reduce((t,e,s,o)=>(s%2==0&&t.push(o.slice(s,s+2)),t),[]);class Transformable extends SubjectModel{constructor(t,e,s){if(super(t),this.constructor===Transformable)throw new TypeError("Cannot construct Transformable instances directly");this.observable=s,EVENTS.forEach(t=>{this.eventDispatcher.registerEvent(t)}),this.enable(e)}_cursorPoint(){throw Error("'_cursorPoint()' method not implemented")}_rotate({radians:t,...e}){const s={transform:this._processRotate(t),delta:t,...e};this.proxyMethods.onRotate.call(this,s),this._emitEvent("rotate",s)}_resize({dx:t,dy:e,...s}){const o={...this._processResize(t,e),dx:t,dy:e,...s};this.proxyMethods.onResize.call(this,o),this._emitEvent("resize",o)}_processOptions(t){const{el:e}=this;addClass(e,"sjx-drag");const s={x:10,y:10,angle:10*RAD},o={move:!1,resize:!1,rotate:!1};let r=null,a=!1,n=!1,i="xy",l=!1,c=5,h=!0,d=!1,p=!1,u=!1,f="auto",x="auto",m="auto",b=!1,y=!0,g=!0,v=!0,T=null,M=50,E=!0,_=null,w=()=>{},S=()=>{},D=()=>{},C=()=>{},V=()=>{},j=()=>{},k=e.parentNode;if(isDef(t)){const{snap:A,each:F,axis:N,cursorMove:z,cursorResize:R,cursorRotate:O,rotationPoint:X,restrict:Y,draggable:L,resizable:P,rotatable:H,onInit:G,onDrop:$,onMove:I,onResize:B,onRotate:U,onDestroy:W,container:q,proportions:Z,keepTransformations:K,custom:Q,rotatorAnchor:J,rotatorOffset:tt,showNormal:et,withoutScaling:st,minSize:ot,allowReversing:rt,minStartDistance:at,processMove:nt,processResize:it}=t;if(isDef(A)){const{x:t,y:e,angle:o}=A;s.x=isUndef(t)?10:t,s.y=isUndef(e)?10:e,s.angle=isUndef(o)?s.angle:o*RAD}if(isDef(F)){const{move:t,resize:e,rotate:s}=F;o.move=t||!1,o.resize=e||!1,o.rotate=s||!1}isDef(Y)&&(r="parent"===Y?e.parentNode:helper(Y)[0]||document),f=z||"auto",x=R||"auto",m=O||"auto",i=N||"xy",k=isDef(q)&&helper(q)[0]?helper(q)[0]:k,b=X||!1,a=Z||!1,n="boolean"==typeof K?K:shouldKeepTransformations(e),l=st||!1,c=ot||5,h=rt||!0,u=at||!1,d=nt||!1,p=it||!1,y=!isDef(L)||L,g=!isDef(P)||P,v=!isDef(H)||H,_="object"==typeof Q&&Q||null,T=J||null,M=tt||50,E=!isDef(et)||et,w=createMethod(G),V=createMethod($),S=createMethod(I),C=createMethod(B),D=createMethod(U),j=createMethod(W)}this.options={axis:i,cursorMove:f,cursorRotate:m,cursorResize:x,rotationPoint:b,restrict:r,container:k,snap:s,each:o,proportions:a,keepTransformations:n,draggable:y,resizable:g,rotatable:v,custom:_,rotatorAnchor:T,rotatorOffset:M,showNormal:E,withoutScaling:l,minSize:c,allowReversing:h,minStartDistance:u,processMove:d,processResize:p},this.proxyMethods={onInit:w,onDrop:V,onMove:S,onResize:C,onRotate:D,onDestroy:j},this.subscribe(o)}_animate(){const t=this,{observable:e,storage:s,options:o}=t;if(isUndef(s))return;if(s.frame=requestAnimFrame(t._animate),!s.doDraw)return;s.doDraw=!1;let{dox:r,doy:a,clientX:n,clientY:i,doDrag:l,doResize:c,doRotate:h,doSetCenter:d,revX:p,revY:u}=s;const{snap:f,each:{move:x,resize:m,rotate:b},restrict:y,draggable:g,resizable:v,rotatable:T}=o;if(c&&v){const{transform:o,cx:l,cy:c}=s,{x:h,y:d}=this._pointToElement({x:n,y:i});let x=r?snapToGrid(h-l,f.x/o.scX):0,b=a?snapToGrid(d-c,f.y/o.scY):0;const y={dx:x=r?p?-x:x:0,dy:b=a?u?-b:b:0,clientX:n,clientY:i};t._resize(y),m&&e.notify("onresize",t,y)}if(l&&g){const{restrictOffset:o,elementOffset:l,nx:c,ny:h}=s;if(isDef(y)){const{left:t,top:e}=o,{left:s,top:r,width:a,height:d}=l,p=c-n,u=h-i,f=y.clientWidth-a,x=y.clientHeight-d,m=r-e,b=s-t;m-u<0&&(i=h-r+e),b-p<0&&(n=c-s+t),m-u>x&&(i=x+(h-r+e)),b-p>f&&(n=f+(c-s+t))}const d={dx:r?snapToGrid(n-c,f.x):0,dy:a?snapToGrid(i-h,f.y):0,clientX:n,clientY:i};t._drag(d),x&&e.notify("onmove",t,d)}if(h&&T){const{pressang:o,center:r}=s,a=Math.atan2(i-r.y,n-r.x)-o,l={clientX:n,clientY:i};t._rotate({radians:snapToGrid(a,f.angle),...l}),b&&e.notify("onrotate",t,{radians:a,...l})}if(d&&T){const{bx:e,by:o}=s,{x:r,y:a}=this._pointToControls({x:n,y:i});t._moveCenterHandle(r-e,a-o)}}_start(t){const{observable:e,storage:s,options:{axis:o,restrict:r,each:a},el:n}=this,i=this._compute(t);Object.keys(i).forEach(t=>{s[t]=i[t]});const{onRightEdge:l,onBottomEdge:c,onTopEdge:h,onLeftEdge:d,handle:p,factor:u,revX:f,revY:x,doW:m,doH:b}=i,y=l||c||h||d,{handles:g}=s,{rotator:v,center:T,radius:M}=g;isDef(M)&&removeClass(M,"sjx-hidden");const E=p.is(v)||v&&p.is(v.firstElementChild),_=!!isDef(T)&&p.is(T),w=!(E||y||_),{clientX:S,clientY:D}=t,{x:C,y:V}=this._cursorPoint({clientX:S,clientY:D}),{x:j,y:k}=this._pointToElement({x:C,y:V}),{x:A,y:F}=this._pointToControls({x:C,y:V}),N={clientX:S,clientY:D,nx:C,ny:V,cx:j,cy:k,bx:A,by:F,doResize:y,doDrag:w,doRotate:E,doSetCenter:_,onExecution:!0,cursor:null,elementOffset:getOffset(n),restrictOffset:isDef(r)?getOffset(r):null,dox:/\x/.test(o)&&(!y||(p.is(g.ml)||p.is(g.mr)||p.is(g.tl)||p.is(g.tr)||p.is(g.bl)||p.is(g.br))),doy:/\y/.test(o)&&(!y||(p.is(g.br)||p.is(g.bl)||p.is(g.bc)||p.is(g.tr)||p.is(g.tl)||p.is(g.tc)))};this.storage={...s,...N};const z={clientX:S,clientY:D};y?this._emitEvent("resizeStart",z):E?this._emitEvent("rotateStart",z):w&&this._emitEvent("dragStart",z);const{move:R,resize:O,rotate:X}=a,Y=y?"resize":E?"rotate":"drag",L=y&&O||E&&X||w&&R;e.notify("ongetstate",this,{clientX:S,clientY:D,actionName:Y,triggerEvent:L,factor:u,revX:f,revY:x,doW:m,doH:b}),this._draw()}_moving(t){const{storage:e,options:s}=this,{x:o,y:r}=this._cursorPoint(t);e.e=t,e.clientX=o,e.clientY=r,e.doDraw=!0;let{doRotate:a,doDrag:n,doResize:i,cursor:l}=e;const{cursorMove:c,cursorResize:h,cursorRotate:d}=s;isUndef(l)&&(n?l=c:a?l=d:i&&(l=h),helper(document.body).css({cursor:l}))}_end({clientX:t,clientY:e}){const{options:{each:s},observable:o,storage:r,proxyMethods:a}=this,{doResize:n,doDrag:i,doRotate:l,frame:c,handles:{radius:h}}=r,d=n?"resize":i?"drag":"rotate";r.doResize=!1,r.doDrag=!1,r.doRotate=!1,r.doSetCenter=!1,r.doDraw=!1,r.onExecution=!1,r.cursor=null,this._apply(d);const p={clientX:t,clientY:e};a.onDrop.call(this,p),n?this._emitEvent("resizeEnd",p):l?this._emitEvent("rotateEnd",p):i&&this._emitEvent("dragEnd",p),r.outOfSnap=!1;const{move:u,resize:f,rotate:x}=s,m=n&&f||l&&x||i&&u;o.notify("onapply",this,{clientX:t,clientY:e,actionName:d,triggerEvent:m}),cancelAnimFrame(c),helper(document.body).css({cursor:"auto"}),isDef(h)&&addClass(h,"sjx-hidden")}_compute(t){const{handles:e}=this.storage,s=helper(t.target),{revX:o,revY:r,doW:a,doH:n,...i}=this._checkHandles(s,e),l=this._getState({revX:o,revY:r,doW:a,doH:n}),{x:c,y:h}=this._cursorPoint(t),d=Math.atan2(h-l.center.y,c-l.center.x);return{...l,...i,handle:s,pressang:d}}_checkHandles(t,e){const{tl:s,tc:o,tr:r,bl:a,br:n,bc:i,ml:l,mr:c}=e,h=!!isDef(s)&&t.is(s),d=!!isDef(o)&&t.is(o),p=!!isDef(r)&&t.is(r),u=!!isDef(a)&&t.is(a),f=!!isDef(i)&&t.is(i),x=!!isDef(n)&&t.is(n),m=!!isDef(l)&&t.is(l),b=!!isDef(c)&&t.is(c);return{revX:h||m||u||d,revY:h||p||d||m,onTopEdge:d||p||h,onLeftEdge:h||m||u,onRightEdge:p||b||x,onBottomEdge:x||f||u,doW:m||b,doH:d||f}}notifyMove(){this._drag(...arguments)}notifyRotate({radians:t,...e}){const{snap:{angle:s}}=this.options;this._rotate({radians:snapToGrid(t,s),...e})}notifyResize(){this._resize(...arguments)}notifyApply({clientX:t,clientY:e,actionName:s,triggerEvent:o}){this.proxyMethods.onDrop.call(this,{clientX:t,clientY:e}),o&&(this._apply(s),this._emitEvent(`${s}End`,{clientX:t,clientY:e}))}notifyGetState({clientX:t,clientY:e,actionName:s,triggerEvent:o,...r}){if(o){const o=this._getState(r);this.storage={...this.storage,...o},this._emitEvent(`${s}Start`,{clientX:t,clientY:e})}}subscribe({resize:t,move:e,rotate:s}){const{observable:o}=this;(e||t||s)&&o.subscribe("ongetstate",this).subscribe("onapply",this),e&&o.subscribe("onmove",this),t&&o.subscribe("onresize",this),s&&o.subscribe("onrotate",this)}unsubscribe(){const{observable:t}=this;t.unsubscribe("ongetstate",this).unsubscribe("onapply",this).unsubscribe("onmove",this).unsubscribe("onresize",this).unsubscribe("onrotate",this)}disable(t,e){const{storage:s,proxyMethods:o,el:r}=this;isUndef(s)||(s.onExecution&&(this._end({clientX:t,clientY:e}),helper(document).off("mousemove",this._onMouseMove).off("mouseup",this._onMouseUp).off("touchmove",this._onTouchMove).off("touchend",this._onTouchEnd)),removeClass(r,"sjx-drag"),this._destroy(),this.unsubscribe(),o.onDestroy.call(this,r),delete this.storage)}exeDrag({dx:t,dy:e}){const{draggable:s}=this.options;s&&(this.storage={...this.storage,...this._getState({revX:!1,revY:!1,doW:!1,doH:!1})},this._drag({dx:t,dy:e}),this._apply("drag"))}exeResize({dx:t,dy:e,revX:s,revY:o,doW:r,doH:a}){const{resizable:n}=this.options;n&&(this.storage={...this.storage,...this._getState({revX:s||!1,revY:o||!1,doW:r||!1,doH:a||!1})},this._resize({dx:t,dy:e}),this._apply("resize"))}exeRotate({delta:t}){const{rotatable:e}=this.options;e&&(this.storage={...this.storage,...this._getState({revX:!1,revY:!1,doW:!1,doH:!1})},this._rotate({radians:t}),this._apply("rotate"))}}const matrixTransform=({x:t,y:e},s)=>{const[o,r,a,n,i,l]=s;return{x:o*t+a*e+i,y:r*t+n*e+l}},matrixInvert=t=>{const e=[[t[0],t[2],t[4]],[t[1],t[3],t[5]],[0,0,1]];if(e.length!==e[0].length)return;const s=e.length,o=[],r=[];for(let t=0;t<s;t+=1){o[o.length]=[],r[r.length]=[];for(let a=0;a<s;a+=1)o[t][a]=t==a?1:0,r[t][a]=e[t][a]}for(let t=0;t<s;t+=1){let e=r[t][t];if(0===e){for(let a=t+1;a<s;a+=1)if(0!==r[a][t]){for(let n=0;n<s;n++)e=r[t][n],r[t][n]=r[a][n],r[a][n]=e,e=o[t][n],o[t][n]=o[a][n],o[a][n]=e;break}if(0===(e=r[t][t]))return}for(let a=0;a<s;a++)r[t][a]=r[t][a]/e,o[t][a]=o[t][a]/e;for(let a=0;a<s;a++)if(a!=t){e=r[a][t];for(let n=0;n<s;n++)r[a][n]-=e*r[t][n],o[a][n]-=e*o[t][n]}}return[o[0][0],o[1][0],o[0][1],o[1][1],o[0][2],o[1][2]]},multiplyMatrix=([t,e,s,o,r,a],[n,i,l,c,h,d])=>{const p=[[t,s,r],[e,o,a],[0,0,1]],u=[[n,l,h],[i,c,d],[0,0,1]],f=[];for(let t=0;t<u.length;t++){f[t]=[];for(let e=0;e<p[0].length;e++){let s=0;for(let o=0;o<p.length;o++)s+=p[o][e]*u[t][o];f[t].push(s)}}return[f[0][0],f[1][0],f[0][1],f[1][1],f[0][2],f[1][2]]},rotatedTopLeft=(t,e,s,o,r,a,n,i,l)=>{const c=parseFloat(s)/2,h=parseFloat(o)/2,d=t+c,p=e+h,u=t-d,f=e-p,x=Math.atan2(i?0:f,l?0:u)+r,m=Math.sqrt(Math.pow(l?0:c,2)+Math.pow(i?0:h,2));let b=Math.cos(x),y=Math.sin(x);const g=p+m*(y=!0===n?-y:y);return{left:floatToFixed(d+m*(b=!0===a?-b:b)),top:floatToFixed(g)}},MIN_SIZE=2,CENTER_DELTA=7;class Draggable extends Transformable{_init(t){const{rotationPoint:e,container:s,resizable:o,rotatable:r,showNormal:a}=this.options,{left:n,top:i,width:l,height:c}=t.style,h=document.createElement("div");addClass(h,"sjx-wrapper"),s.appendChild(h);const d=helper(t),p=l||d.css("width"),u=c||d.css("height"),f={top:i||d.css("top"),left:n||d.css("left"),width:p,height:u,transform:getTransform(d)},x=document.createElement("div");addClass(x,"sjx-controls");const m={...r&&{normal:a?["sjx-normal"]:null,rotator:["sjx-hdl","sjx-hdl-m","sjx-rotator"]},...o&&{tl:["sjx-hdl","sjx-hdl-t","sjx-hdl-l","sjx-hdl-tl"],tr:["sjx-hdl","sjx-hdl-t","sjx-hdl-r","sjx-hdl-tr"],br:["sjx-hdl","sjx-hdl-b","sjx-hdl-r","sjx-hdl-br"],bl:["sjx-hdl","sjx-hdl-b","sjx-hdl-l","sjx-hdl-bl"],tc:["sjx-hdl","sjx-hdl-t","sjx-hdl-c","sjx-hdl-tc"],bc:["sjx-hdl","sjx-hdl-b","sjx-hdl-c","sjx-hdl-bc"],ml:["sjx-hdl","sjx-hdl-m","sjx-hdl-l","sjx-hdl-ml"],mr:["sjx-hdl","sjx-hdl-m","sjx-hdl-r","sjx-hdl-mr"]},center:e&&r?["sjx-hdl","sjx-hdl-m","sjx-hdl-c","sjx-hdl-mc"]:void 0};if(Object.keys(m).forEach(t=>{const e=m[t];if(isUndef(e))return;const s=createHandler(e);m[t]=s,x.appendChild(s)}),isDef(m.center)){helper(m.center).css({left:`${t.getAttribute("data-cx")}px`,top:`${t.getAttribute("data-cy")}px`})}h.appendChild(x);const b=helper(x);b.css(f),this.storage={controls:x,handles:m,radius:void 0,parent:t.parentNode},b.on("mousedown",this._onMouseDown).on("touchstart",this._onTouchStart)}_destroy(){const{controls:t}=this.storage;helper(t).off("mousedown",this._onMouseDown).off("touchstart",this._onTouchStart);const e=t.parentNode;e.parentNode.removeChild(e)}_pointToElement({x:t,y:e}){const{transform:s}=this.storage,o=[...s.matrix];return o[4]=o[5]=0,this._applyMatrixToPoint(matrixInvert(o),t,e)}_pointToControls(t){return this._pointToElement(t)}_applyMatrixToPoint(t,e,s){return matrixTransform({x:e,y:s},t)}_cursorPoint({clientX:t,clientY:e}){const{container:s}=this.options,o=parseMatrix(getTransform(helper(s)));return matrixTransform({x:t,y:e},matrixInvert(o))}_apply(){const{el:t,storage:e}=this,{controls:s,handles:o}=e,r=helper(s),a=parseFloat(r.css("width"))/2,n=parseFloat(r.css("height"))/2,{center:i}=o,l=isDef(i),c=l?parseFloat(helper(i).css("left")):a,h=l?parseFloat(helper(i).css("top")):n;t.setAttribute("data-cx",c),t.setAttribute("data-cy",h),this.storage.cached=null}_processResize(t,e){const{el:s,storage:o,options:{proportions:r}}=this,{controls:a,coords:n,cw:i,ch:l,transform:c,refang:h,revX:d,revY:p,doW:u,doH:f}=o,x=u||!u&&!f?(i+t)/i:(l+e)/l,m=r?i*x:i+t,b=r?l*x:l+e;if(m<=MIN_SIZE||b<=MIN_SIZE)return;const y=[...c.matrix],g=rotatedTopLeft(y[4],y[5],m,b,h,d,p,u,f),v=n.left-g.left,T=n.top-g.top;y[4]+=v,y[5]+=T;const M=matrixToCSS(y);return M.width=`${m}px`,M.height=`${b}px`,helper(a).css(M),helper(s).css(M),o.cached={dx:v,dy:T},{width:m,height:b,ox:v,oy:T}}_processMove(t,e){const{el:s,storage:o}=this,{controls:r,transform:{matrix:a,parentMatrix:n}}=o,i=[...n];i[4]=i[5]=0;const l=[...a];l[4]=a[4]+t,l[5]=a[5]+e;const c=matrixToCSS(l);return helper(r).css(c),helper(s).css(c),o.cached={dx:t,dy:e},l}_processRotate(t){const{el:e,storage:{controls:s,transform:o,center:r}}=this,{matrix:a,parentMatrix:n}=o,i=floatToFixed(Math.cos(t),4),l=floatToFixed(Math.sin(t),4),c=[1,0,0,1,r.cx,r.cy],h=[i,l,-l,i,0,0],d=[...n];d[4]=d[5]=0;const p=multiplyMatrix(matrixInvert(d),multiplyMatrix(h,d)),u=multiplyMatrix(multiplyMatrix(c,p),matrixInvert(c)),f=multiplyMatrix(u,a),x=matrixToCSS(f);return helper(s).css(x),helper(e).css(x),f}_getState(t){const{revX:e,revY:s,doW:o,doH:r}=t,a=e!==s?-1:1,{el:n,storage:{handles:i,controls:l,parent:c},options:{container:h}}=this,{center:d}=i,p=helper(l),u=parseMatrix(getTransform(helper(h))),f=parseMatrix(getTransform(helper(l))),x=parseMatrix(getTransform(helper(c))),m=Math.atan2(f[1],f[0])*a,b=c!==h?multiplyMatrix(x,u):u,y={matrix:f,parentMatrix:b,scX:Math.sqrt(f[0]*f[0]+f[1]*f[1]),scY:Math.sqrt(f[2]*f[2]+f[3]*f[3])},g=parseFloat(p.css("width")),v=parseFloat(p.css("height")),T=rotatedTopLeft(f[4],f[5],g,v,m,e,s,o,r),M=g/2,E=v/2,_=getOffset(n),w=isDef(d),S=w?parseFloat(helper(d).css("left")):M,D=w?parseFloat(helper(d).css("top")):E,C=w?CENTER_DELTA:0,{x:V,y:j}=matrixTransform({x:_.left,y:_.top},matrixInvert(b));return{transform:y,cw:g,ch:v,coords:T,center:{x:V+S-C,y:j+D-C,cx:-S+M-C,cy:-D+E-C,hx:S,hy:D},factor:a,refang:m,revX:e,revY:s,doW:o,doH:r}}_moveCenterHandle(t,e){const{handles:{center:s},center:{hx:o,hy:r}}=this.storage,a=`${o+t}px`,n=`${r+e}px`;helper(s).css({left:a,top:n})}resetCenterPoint(){const{handles:{center:t}}=this.storage;helper(t).css({left:null,top:null})}fitControlsToSize(){}get controls(){return this.storage.controls}}const createHandler=t=>{const e=document.createElement("div");return t.forEach(t=>{addClass(e,t)}),e},dRE=/\s*([achlmqstvz])([^achlmqstvz]*)\s*/gi,sepRE=/\s*,\s*|\s+/g,parsePath=t=>{let e=dRE.lastIndex=0;const s=[];for(;e=dRE.exec(t);){const t=e[1],o=t.toUpperCase(),r=e[2].replace(/([^e])-/g,"$1 -").replace(/ +/g," ");s.push({relative:t!==o,key:o,cmd:t,values:r.trim().split(sepRE).map(t=>{if(!isNaN(t))return Number(t)})})}return s},movePath=t=>{const{path:e,dx:s,dy:o}=t;try{const t=parsePath(e);let r="",a=" ",n=!0;for(let e=0,i=t.length;e<i;e++){const i=t[e],{values:l,key:c,relative:h}=i,d=[];switch(c){case"M":for(let t=0,e=l.length;t<e;t+=2){let[e,r]=l.slice(t,t+2);h&&!n||(e+=s,r+=o),d.push(e,r),n=!1}break;case"A":for(let t=0,e=l.length;t<e;t+=7){const e=l.slice(t,t+7);h||(e[5]+=s,e[6]+=o),d.push(...e)}break;case"C":for(let t=0,e=l.length;t<e;t+=6){const e=l.slice(t,t+6);h||(e[0]+=s,e[1]+=o,e[2]+=s,e[3]+=o,e[4]+=s,e[5]+=o),d.push(...e)}break;case"H":for(let t=0,e=l.length;t<e;t+=1){const e=l.slice(t,t+1);h||(e[0]+=s),d.push(e[0])}break;case"V":for(let t=0,e=l.length;t<e;t+=1){const e=l.slice(t,t+1);h||(e[0]+=o),d.push(e[0])}break;case"L":case"T":for(let t=0,e=l.length;t<e;t+=2){let[e,r]=l.slice(t,t+2);h||(e+=s,r+=o),d.push(e,r)}break;case"Q":case"S":for(let t=0,e=l.length;t<e;t+=4){let[e,r,a,n]=l.slice(t,t+4);h||(e+=s,r+=o,a+=s,n+=o),d.push(e,r,a,n)}break;case"Z":l[0]="",a=""}r+=i.cmd+d.join(",")+a}return r}catch(t){warn("Path parsing error: "+t)}},resizePath=t=>{const{path:e,localCTM:s}=t;try{const t=parsePath(e);let o="",r=" ";const a=[];let n=!0;for(let e=0,i=t.length;e<i;e++){const i=t[e],{values:l,key:c,relative:h}=i;switch(c){case"A":{const t=[];for(let e=0,o=l.length;e<o;e+=7){const[o,r,a,n,i,c,d]=l.slice(e,e+7),p=cloneMatrix(s);h&&(p.e=p.f=0);const{x:u,y:f}=pointTo(p,c,d);t.push(floatToFixed(u),floatToFixed(f)),p.e=p.f=0;const{x:x,y:m}=pointTo(p,o,r);t.unshift(floatToFixed(x),floatToFixed(m),a,n,i)}a.push(t);break}case"C":{const t=[];for(let e=0,o=l.length;e<o;e+=6){const[o,r,a,n,i,c]=l.slice(e,e+6),d=cloneMatrix(s);h&&(d.e=d.f=0);const{x:p,y:u}=pointTo(d,o,r),{x:f,y:x}=pointTo(d,a,n),{x:m,y:b}=pointTo(d,i,c);t.push(floatToFixed(p),floatToFixed(u),floatToFixed(f),floatToFixed(x),floatToFixed(m),floatToFixed(b))}a.push(t);break}case"H":{const t=[];for(let e=0,o=l.length;e<o;e+=1){const[o]=l.slice(e,e+1),r=cloneMatrix(s);h&&(r.e=r.f=0);const{x:a}=pointTo(r,o,0);t.push(floatToFixed(a))}a.push(t);break}case"V":{const t=[];for(let e=0,o=l.length;e<o;e+=1){const[o]=l.slice(e,e+1),r=cloneMatrix(s);h&&(r.e=r.f=0);const{y:a}=pointTo(r,0,o);t.push(floatToFixed(a))}a.push(t);break}case"T":case"L":{const t=[];for(let e=0,o=l.length;e<o;e+=2){const[o,r]=l.slice(e,e+2),a=cloneMatrix(s);h&&(a.e=a.f=0);const{x:n,y:i}=pointTo(a,o,r);t.push(floatToFixed(n),floatToFixed(i))}a.push(t);break}case"M":{const t=[];for(let e=0,o=l.length;e<o;e+=2){const[o,r]=l.slice(e,e+2),a=cloneMatrix(s);h&&!n&&(a.e=a.f=0);const{x:i,y:c}=pointTo(a,o,r);t.push(floatToFixed(i),floatToFixed(c)),n=!1}a.push(t);break}case"Q":{const t=[];for(let e=0,o=l.length;e<o;e+=4){const[o,r,a,n]=l.slice(e,e+4),i=cloneMatrix(s);h&&(i.e=i.f=0);const{x:c,y:d}=pointTo(i,o,r),{x:p,y:u}=pointTo(i,a,n);t.push(floatToFixed(c),floatToFixed(d),floatToFixed(p),floatToFixed(u))}a.push(t);break}case"S":{const t=[];for(let e=0,o=l.length;e<o;e+=4){const[o,r,a,n]=l.slice(e,e+4),i=cloneMatrix(s);h&&(i.e=i.f=0);const{x:c,y:d}=pointTo(i,o,r),{x:p,y:u}=pointTo(i,a,n);t.push(floatToFixed(c),floatToFixed(d),floatToFixed(p),floatToFixed(u))}a.push(t);break}case"Z":a.push([""]),r=""}o+=i.cmd+a[e].join(",")+r}return o}catch(t){warn("Path parsing error: "+t)}},THEME_COLOR="#00a8ff";class DraggableSVG extends Transformable{_init(t){const{rotationPoint:e,container:s,resizable:o,rotatable:r,rotatorAnchor:a,rotatorOffset:n,showNormal:i,custom:l}=this.options,c=createSVGElement("g");addClass(c,"sjx-svg-wrapper"),addClass(c,t.nodeName),s.appendChild(c);const{width:h,height:d,x:p,y:u}=t.getBBox(),f=getTransformToElement(t,s),x=createSVGElement("rect");[["width",h],["height",d],["x",p],["y",u],["fill",THEME_COLOR],["fill-opacity",0],["stroke",THEME_COLOR],["stroke-dasharray","3 3"],["vector-effect","non-scaling-stroke"],["transform",matrixToString(f)]].forEach(([t,e])=>{x.setAttribute(t,e)});const m=createSVGElement("g"),b=createSVGElement("g"),y=createSVGElement("g");addClass(y,"sjx-svg-box-group"),addClass(m,"sjx-svg-handles"),addClass(b,"sjx-svg-normal-group"),y.appendChild(x),c.appendChild(y),c.appendChild(b),c.appendChild(m);const g=x.getBBox(),{x:v,y:T,width:M,height:E}=g,_=t.getAttribute("data-cx"),w=t.getAttribute("data-cy"),S=getTransformToElement(x,x.parentNode),D=pointTo(S,v+M/2,T+E/2),C=pointTo(S,v,T),V=pointTo(S,v+M,T),j=pointTo(S,v+M,T+E/2),k=pointTo(S,v,T+E/2),A=pointTo(S,v+M/2,T),F=pointTo(S,v+M/2,T+E),N=pointTo(S,v+M,T+E),z=pointTo(S,v,T+E),R={tl:C,tr:V,br:N,bl:z,tc:A,bc:F,ml:k,mr:j};let O={},X=null;if(r){const t={};let s=1;switch(a){case"n":t.x=A.x,t.y=A.y;break;case"s":t.x=F.x,t.y=F.y,s=-1;break;case"w":t.x=k.x,t.y=k.y,s=-1;break;case"e":default:t.x=j.x,t.y=j.y}const o="n"===a||"s"===a?Math.atan2(z.y-C.y,z.x-C.x):Math.atan2(C.y-V.y,C.x-V.x);X={x:t.x-n*s*Math.cos(o),y:t.y-n*s*Math.sin(o)};const r=i?createSVGElement("line"):null;i&&(r.x1.baseVal.value=t.x,r.y1.baseVal.value=t.y,r.x2.baseVal.value=X.x,r.y2.baseVal.value=X.y,setLineStyle(r,THEME_COLOR),b.appendChild(r));let l=null;e&&(l=createSVGElement("line"),addClass(l,"sjx-hidden"),l.x1.baseVal.value=D.x,l.y1.baseVal.value=D.y,l.x2.baseVal.value=_||D.x,l.y2.baseVal.value=w||D.y,setLineStyle(l,"#fe3232"),l.setAttribute("opacity",.5),b.appendChild(l)),O={normal:r,radius:l}}const Y={...o&&R,rotator:X,center:e&&r?createPoint(s,_,w)||D:void 0};Object.keys(Y).forEach(t=>{const e=Y[t];if(isUndef(e))return;const{x:s,y:o}=e,r="center"===t?"#fe3232":THEME_COLOR;isDef(l)&&isFunc(l[t])?Y[t]=l[t](S,g,pointTo):Y[t]=createHandler$1(s,o,r,t),m.appendChild(Y[t])}),this.storage={wrapper:c,box:x,handles:{...Y,...O},parent:t.parentNode},helper(c).on("mousedown",this._onMouseDown).on("touchstart",this._onTouchStart)}fitTo(t,e){const{options:s,storage:o}=this,{box:r}=o;if(e){const e=parseFloat(r.getAttribute("height"));parseFloat(t.getAttribute("height"))<e&&t.setAttribute("height",e)}r.setAttribute("height",t.getAttribute("height"));const{x:a,y:n}=r.getBBox();applyTransformToHandles(o,s,{x:a,y:n,width:parseFloat(r.getAttribute("width")),height:parseFloat(r.getAttribute("height")),boxMatrix:null})}_destroy(){const{wrapper:t}=this.storage;helper(t).off("mousedown",this._onMouseDown).off("touchstart",this._onTouchStart),t.parentNode.removeChild(t)}_cursorPoint(t){const{container:e}=this.options,s=e.getBoundingClientRect(),o=e.getScreenCTM();return o.e=s.x,o.f=s.y,pointTo(o.inverse(),t.clientX,t.clientY)}_pointToElement({x:t,y:e}){const{transform:s}=this.storage,{ctm:o}=s,r=o.inverse();return r.e=r.f=0,this._applyMatrixToPoint(r,t,e)}_pointToControls({x:t,y:e}){const{transform:s}=this.storage,{boxCTM:o}=s,r=o.inverse();return r.e=r.f=0,this._applyMatrixToPoint(r,t,e)}_applyMatrixToPoint(t,e,s){const{container:o}=this.options,r=o.createSVGPoint();return r.x=e,r.y=s,r.matrixTransform(t)}_apply(t){const{el:e,storage:s,options:o,options:{container:r}}=this,{box:a,handles:n,cached:i,transform:l}=s,{matrix:c,boxCTM:h,bBox:d,ctm:p}=l,u=e.getBBox(),{x:f,y:x,width:m,height:b}=u,y=isDef(n.center)?pointTo(h,n.center.cx.baseVal.value,n.center.cy.baseVal.value):pointTo(c,f+m/2,x+b/2);if(e.setAttribute("data-cx",y.x),e.setAttribute("data-cy",y.y),isUndef(i))return;const{scaleX:g,scaleY:v,dx:T,dy:M}=i;if("drag"===t){if(0===T&&0===M)return;const t=createSVGMatrix();t.e=T,t.f=M;const s=t.multiply(c).multiply(t.inverse());o.keepTransformations||(e.setAttribute("transform",matrixToString(s)),applyTranslate(e,{x:T,y:M}))}if("resize"===t){const{x:t,y:n,width:i,height:l}=a.getBBox();o.keepTransformations?this.storage.temporalCtm=p:(applyTransformToHandles(s,o,{x:t,y:n,width:i,height:l,boxMatrix:null}),applyResize(e,{scaleX:g,scaleY:v,defaultCTM:p,bBox:d,container:r,storage:s,withoutScaling:o.withoutScaling}),e.setAttribute("transform",matrixToString(c)))}this.storage.cached=null}_processResize(t,e){const{el:s,storage:o,options:r,options:{proportions:a,processResize:n,withoutScaling:i,minSize:l,allowReversing:c}}=this,{left:h,top:d,cw:p,ch:u,transform:f,revX:x,revY:m,doW:b,doH:y}=o,{matrix:g,scMatrix:v,trMatrix:T,scaleX:M,scaleY:E}=f;let{width:_,height:w}=s.getBBox();s.dataset.temporalWidth&&(_=s.dataset.temporalWidth,w=s.dataset.temporalHeight);const S={};if(n){const s=n(t,e,x,m);S.fdx=t+(s&&s.x?s.x:0),S.fdy=e+(s&&s.y?s.y:0),t+=s&&s.x?s.x:0,e+=s&&s.y?s.y:0}let D=b||!b&&!y?(p+t)/p:(u+e)/u;if(_=a?p*D:p+t,w=a?u*D:u+e,Math.abs(_)<=l||Math.abs(w)<=l)return;if((i||c)&&_<=0)return;if((i||c)&&w<=0)return;const C=_/p,V=w/u;if(v.a=C,v.b=0,v.c=0,v.d=V,v.e=0,v.f=0,T.e=M,T.f=E,i){const s=t<0?Math.abs(t):-Math.abs(t),o=e<0?Math.abs(e):-Math.abs(e);v.a=1,v.b=0,v.c=0,v.d=1,v.e=x?s:0,v.f=m?o:0}const j=T.multiply(v).multiply(T.inverse()),k=g.multiply(j);s.setAttribute("transform",matrixToString(k)),i&&(s.setAttribute("width",_),s.setAttribute("height",w));const A=h-(_-p)*(y?.5:x?1:0),F=d-(w-u)*(b?.5:m?1:0);this.storage.cached={scaleX:C,scaleY:V};const N={x:A,y:F,width:_,height:w,...S};return applyTransformToHandles(o,r,{...N,boxMatrix:null}),N}_processMove(t,e){const{transform:s,wrapper:o,center:r}=this.storage,{options:{processMove:a,minStartDistance:n}}=this,{matrix:i,trMatrix:l,scMatrix:c,wrapperMatrix:h,parentMatrix:d}=s;!this.storage.outOfSnap&&n&&Math.abs(t)<n&&Math.abs(e)<n?(t=0,e=0):this.storage.outOfSnap=!0,c.e=t,c.f=e;const p=c.multiply(h);o.setAttribute("transform",matrixToString(p)),d.e=d.f=0;const{x:u,y:f}=pointTo(d.inverse(),t,e);l.e=u,l.f=f;let x=a&&a(u,f);const m={fdx:t,fdy:e};if(x){const s=rotateCoordinates(x.x||0,x.y||0,0,0,x.rotation||0);p.e+=s.x,p.f+=s.y,o.setAttribute("transform",matrixToString(p)),l.e+=x.x/d.a||0,l.f+=x.y/d.d||0,m.fdx=t+x.x,m.fdy=e+x.y,t<0&&t>m.fdx?m.fdx=t:t>0&&t<m.fdx&&(m.fdx=t),e<0&&e>m.fdy?m.fdy=e:e>0&&e<m.fdy&&(m.fdy=e)}const b=l.multiply(i);if(this.el.setAttribute("transform",matrixToString(b)),this.storage.cached={dx:u,dy:f,ox:t,oy:e},r.isShifted){const s=h.inverse();s.e=s.f=0;const{x:o,y:r}=pointTo(s,t,e);this._moveCenterHandle(-o,-r)}return{transform:b,fixedDeltas:m}}_processRotate(t){const{center:e,transform:s,wrapper:o}=this.storage,{matrix:r,wrapperMatrix:a,parentMatrix:n,trMatrix:i,scMatrix:l,rotMatrix:c}=s,h=floatToFixed(Math.cos(t)),d=floatToFixed(Math.sin(t));i.e=e.x,i.f=e.y,c.a=h,c.b=d,c.c=-d,c.d=h;const p=i.multiply(c).multiply(i.inverse()).multiply(a);o.setAttribute("transform",matrixToString(p)),l.e=e.el_x,l.f=e.el_y,n.e=n.f=0;const u=n.inverse().multiply(c).multiply(n),f=l.multiply(u).multiply(l.inverse()).multiply(r);return this.el.setAttribute("transform",matrixToString(f)),f}_getState({revX:t,revY:e,doW:s,doH:o}){const{el:r,storage:a,options:{container:n}}=this,{box:i,wrapper:l,parent:c,handles:{center:h}}=a,d=r.getBBox(),{x:p,y:u,width:f,height:x}=d,{width:m,height:b,x:y,y:g}=i.getBBox(),v=getTransformToElement(r,c),T=a.temporalCtm||getTransformToElement(r,n),M=getTransformToElement(i.parentNode,n),E=getTransformToElement(c,n),_=p+f*(o?.5:t?1:0),w=u+x*(s?.5:e?1:0),S={matrix:v,ctm:T,boxCTM:M,parentMatrix:E,wrapperMatrix:getTransformToElement(l,l.parentNode),trMatrix:createSVGMatrix(),scMatrix:createSVGMatrix(),rotMatrix:createSVGMatrix(),scaleX:_,scaleY:w,scX:Math.sqrt(T.a*T.a+T.b*T.b),scY:Math.sqrt(T.c*T.c+T.d*T.d),bBox:d},D=y+m/2,C=g+b/2,V=h?h.cx.baseVal.value:D,j=h?h.cy.baseVal.value:C,{x:k,y:A}=pointTo(M,V,j),{x:F,y:N}=isDef(h)?pointTo(E.inverse(),k,A):pointTo(v,p+f/2,u+x/2),{x:z,y:R}=pointTo(getTransformToElement(i,n),D,C);return checkChildElements(r).forEach(t=>{t.__ctm__=getTransformToElement(t,n)}),{transform:S,cw:m,ch:b,center:{x:h?k:z,y:h?A:R,el_x:F,el_y:N,hx:h?h.cx.baseVal.value:null,hy:h?h.cy.baseVal.value:null,isShifted:floatToFixed(z,3)!==floatToFixed(k,3)&&floatToFixed(R,3)!==floatToFixed(A,3)},left:y,top:g,revX:t,revY:e,doW:s,doH:o}}_moveCenterHandle(t,e){const{handles:{center:s,radius:o},center:{hx:r,hy:a}}=this.storage;if(isUndef(s))return;const n=r+t,i=a+e;s.cx.baseVal.value=n,s.cy.baseVal.value=i,o.x2.baseVal.value=n,o.y2.baseVal.value=i}resetCenterPoint(){const{box:t,handles:{center:e,radius:s}}=this.storage,{width:o,height:r,x:a,y:n}=t.getBBox(),i=getTransformToElement(t,t.parentNode),{x:l,y:c}=pointTo(i,a+o/2,n+r/2);e.cx.baseVal.value=l,e.cy.baseVal.value=c,e.isShifted=!1,s.x2.baseVal.value=l,s.y2.baseVal.value=c}fitControlsToSize(){const{el:t,storage:{box:e,wrapper:s},options:{container:o}}=this,{width:r,height:a,x:n,y:i}=t.getBBox();this.storage.ch=a;const l=getTransformToElement(t,o);s.removeAttribute("transform"),e.setAttribute("transform",matrixToString(l)),applyTransformToHandles(this.storage,this.options,{x:n,y:i,width:r,height:a,boxMatrix:l})}get controls(){return this.storage.wrapper}}const applyTranslate=(t,{x:e,y:s})=>{const o=[];switch(t.tagName.toLowerCase()){case"text":{const r=isDef(t.x.baseVal[0])?t.x.baseVal[0].value+e:(Number(t.getAttribute("x"))||0)+e,a=isDef(t.y.baseVal[0])?t.y.baseVal[0].value+s:(Number(t.getAttribute("y"))||0)+s;o.push(["x",r],["y",a]);break}case"use":case"image":case"rect":{const r=isDef(t.x.baseVal.value)?t.x.baseVal.value+e:(Number(t.getAttribute("x"))||0)+e,a=isDef(t.y.baseVal.value)?t.y.baseVal.value+s:(Number(t.getAttribute("y"))||0)+s;o.push(["x",r],["y",a]);break}case"circle":case"ellipse":{const r=t.cx.baseVal.value+e,a=t.cy.baseVal.value+s;o.push(["cx",r],["cy",a]);break}case"line":{const r=t.x1.baseVal.value+e,a=t.y1.baseVal.value+s,n=t.x2.baseVal.value+e,i=t.y2.baseVal.value+s;o.push(["x1",r],["y1",a],["x2",n],["y2",i]);break}case"polygon":case"polyline":{const r=parsePoints(t.getAttribute("points")).map(t=>(t[0]=Number(t[0])+e,t[1]=Number(t[1])+s,t.join(" "))).join(" ");o.push(["points",r]);break}case"path":{const r=t.getAttribute("d");o.push(["d",movePath({path:r,dx:e,dy:s})]);break}}o.forEach(e=>{t.setAttribute(e[0],e[1])})},applyResize=(t,e)=>{const{scaleX:s,scaleY:o,bBox:r,defaultCTM:a,container:n,withoutScaling:i}=e,{width:l,height:c}=r,h=[],d=getTransformToElement(t,n),p=a.inverse().multiply(d);switch(t.tagName.toLowerCase()){case"text":{const e=isDef(t.x.baseVal[0])?t.x.baseVal[0].value:Number(t.getAttribute("x"))||0,r=isDef(t.y.baseVal[0])?t.y.baseVal[0].value:Number(t.getAttribute("y"))||0,{x:a,y:n}=pointTo(p,e,r);h.push(["x",a+(s<0?l:0)],["y",n+(o<0?c:0)]);break}case"circle":{const e=t.r.baseVal.value,r=t.cx.baseVal.value,a=t.cy.baseVal.value,n=e*(Math.abs(s)+Math.abs(o))/2,{x:i,y:l}=pointTo(p,r,a);h.push(["r",n],["cx",i],["cy",l]);break}case"image":case"foreignobject":case"rect":{const e=t.width.baseVal.value,r=t.height.baseVal.value,a=t.x.baseVal.value,n=t.y.baseVal.value,{x:l,y:c}=pointTo(p,a,n),d=Math.abs(e*s),u=Math.abs(r*o);h.push(["x",l-(s<0?d:0)],["y",c-(o<0?u:0)]),i||(t.dataset.scale=s,h.push(["width",d],["height",u]));break}case"ellipse":{const e=t.rx.baseVal.value,r=t.ry.baseVal.value,a=t.cx.baseVal.value,n=t.cy.baseVal.value,{x:i,y:l}=pointTo(p,a,n),c=createSVGMatrix();c.a=s,c.d=o;const{x:d,y:u}=pointTo(c,e,r);h.push(["rx",Math.abs(d)],["ry",Math.abs(u)],["cx",i],["cy",l]);break}case"line":{const e=t.x1.baseVal.value,s=t.y1.baseVal.value,o=t.x2.baseVal.value,r=t.y2.baseVal.value,{x:a,y:n}=pointTo(p,e,s),{x:i,y:l}=pointTo(p,o,r);h.push(["x1",a],["y1",n],["x2",i],["y2",l]);break}case"polygon":case"polyline":{const e=parsePoints(t.getAttribute("points")).map(t=>{const{x:e,y:s}=pointTo(p,Number(t[0]),Number(t[1]));return t[0]=e,t[1]=s,t.join(" ")}).join(" ");h.push(["points",e]);break}case"path":{const e=t.getAttribute("d");h.push(["d",resizePath({path:e,localCTM:p})]);break}}h.forEach(([e,s])=>{t.setAttribute(e,s)})},applyTransformToHandles=(t,e,s)=>{const{rotatable:o,rotatorAnchor:r,rotatorOffset:a}=e,{box:n,handles:i,center:l}=t;let{x:c,y:h,width:d,height:p,boxMatrix:u}=s;const f=d/2,x=p/2,m=null!==u?u:getTransformToElement(n,n.parentNode),b=pointTo(m,c+f,h+x),y={tl:pointTo(m,c,h),tr:pointTo(m,c+d,h),br:pointTo(m,c+d,h+p),bl:pointTo(m,c,h+p),tc:pointTo(m,c+f,h),bc:pointTo(m,c+f,h+p),ml:pointTo(m,c,h+x),mr:pointTo(m,c+d,h+x),center:isDef(i.center)&&!l.isShifted?b:void 0};if(o){const t={};let e=1;switch(r){case"n":t.x=y.tc.x,t.y=y.tc.y;break;case"s":t.x=y.bc.x,t.y=y.bc.y,e=-1;break;case"w":t.x=y.ml.x,t.y=y.ml.y,e=-1;break;case"e":default:t.x=y.mr.x,t.y=y.mr.y}const s="n"===r||"s"===r?Math.atan2(y.bl.y-y.tl.y,y.bl.x-y.tl.x):Math.atan2(y.tl.y-y.tr.y,y.tl.x-y.tr.x),o={x:t.x-a*e*Math.cos(s),y:t.y-a*e*Math.sin(s)},{normal:n,radius:c}=i;isDef(n)&&(n.x1.baseVal.value=t.x,n.y1.baseVal.value=t.y,n.x2.baseVal.value=o.x,n.y2.baseVal.value=o.y),isDef(c)&&(c.x1.baseVal.value=b.x,c.y1.baseVal.value=b.y,l.isShifted||(c.x2.baseVal.value=b.x,c.y2.baseVal.value=b.y)),y.rotator=o}const g={x:c+=d<0?d:0,y:h+=p<0?p:0,width:Math.abs(d),height:Math.abs(p)};Object.keys(g).forEach(t=>{n.setAttribute(t,g[t])}),Object.keys(y).forEach(t=>{const e=i[t],s=y[t];isUndef(s)||isUndef(e)||("g"===e.tagName||"path"===e.tagName?e.instance&&"path"===e.tagName?e.instance.transform({x:s.x,y:s.y}):e.setAttribute("transform",`matrix(1, 0, 0, 1, ${s.x}, ${s.y})`):(e.setAttribute("cx",s.x),e.setAttribute("cy",s.y)))})},createHandler$1=(t,e,s,o)=>{const r=createSVGElement("circle");addClass(r,`sjx-svg-hdl-${o}`);const a={cx:t,cy:e,r:5.5,fill:s,stroke:"#fff","fill-opacity":1,"vector-effect":"non-scaling-stroke","stroke-width":1};return Object.keys(a).map(t=>{r.setAttribute(t,a[t])}),r},setLineStyle=(t,e)=>{t.setAttribute("stroke",e),t.setAttribute("stroke-dasharray","3 3"),t.setAttribute("vector-effect","non-scaling-stroke")};function drag(t,e){if(this.length){const s=isDef(e)&&e instanceof Observable?e:new Observable;return arrReduce.call(this,(e,o)=>(o instanceof SVGElement?checkElement(o)&&e.push(new DraggableSVG(o,t,s)):e.push(new Draggable(o,t,s)),e),[])}}class Cloneable extends SubjectModel{constructor(t,e){super(t),this.enable(e)}_init(){const{el:t,options:e}=this,s=helper(t),{style:o,appendTo:r}=e,a={position:"absolute","z-index":"2147483647",...o};this.storage={css:a,parent:isDef(r)?helper(r)[0]:document.body},s.on("mousedown",this._onMouseDown).on("touchstart",this._onTouchStart),EVENTS.slice(0,3).forEach(t=>{this.eventDispatcher.registerEvent(t)})}_processOptions(t){let e={},s=null,o=document,r=()=>{},a=()=>{},n=()=>{},i=()=>{};if(isDef(t)){const{style:o,appendTo:l,stack:c,onInit:h,onMove:d,onDrop:p,onDestroy:u}=t;e=isDef(o)&&"object"==typeof o?o:e,s=l||null;const f=isDef(c)?helper(c)[0]:document;r=createMethod(h),a=createMethod(d),n=isFunc(p)?function(t){const{clone:e}=this.storage;objectsCollide(e,f)&&p.call(this,t,this.el,e)}:()=>{},i=createMethod(u)}this.options={style:e,appendTo:s,stack:o},this.proxyMethods={onInit:r,onDrop:n,onMove:a,onDestroy:i}}_start({clientX:t,clientY:e}){const{storage:s,el:o}=this,{parent:r,css:a}=s,{left:n,top:i}=getOffset(r);a.left=`${t-n}px`,a.top=`${e-i}px`;const l=o.cloneNode(!0);helper(l).css(a),s.clientX=t,s.clientY=e,s.cx=t,s.cy=e,s.clone=l,helper(r)[0].appendChild(l),this._draw()}_moving({clientX:t,clientY:e}){const{storage:s}=this;s.clientX=t,s.clientY=e,s.doDraw=!0,s.doMove=!0}_end(t){const{storage:e}=this,{clone:s,frameId:o}=e;e.doDraw=!1,cancelAnimFrame(o),isUndef(s)||(this.proxyMethods.onDrop.call(this,t),s.parentNode.removeChild(s),delete e.clone)}_animate(){const{storage:t}=this;t.frameId=requestAnimFrame(this._animate);const{doDraw:e,clientX:s,clientY:o,cx:r,cy:a}=t;e&&(t.doDraw=!1,this._drag({dx:s-r,dy:o-a}))}_processMove(t,e){const{clone:s}=this.storage,o=`translate(${t}px, ${e}px)`;helper(s).css({transform:o,webkitTranform:o,mozTransform:o,msTransform:o,otransform:o})}_destroy(){const{storage:t,proxyMethods:e,el:s}=this;isUndef(t)||(helper(s).off("mousedown",this._onMouseDown).off("touchstart",this._onTouchStart),e.onDestroy.call(this,s),delete this.storage)}disable(){this._destroy()}}function clone(t){if(this.length)return arrMap.call(this,e=>new Cloneable(e,t))}class Subjx extends Helper{drag(){return drag.call(this,...arguments)}clone(){return clone.call(this,...arguments)}}function subjx(t){return new Subjx(t)}Object.defineProperty(subjx,"createObservable",{value:()=>new Observable}),Object.defineProperty(subjx,"Subjx",{value:Subjx}),Object.defineProperty(subjx,"Observable",{value:Observable}),module.exports=subjx;
